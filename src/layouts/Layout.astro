---
import "@styles/global.css";
import { ClientRouter } from "astro:transitions";
import Header from "@components/common/Header.astro";
import Footer from "@components/common/Footer.astro";
import SEO from "@components/common/SEO.astro";
import faviconSVG from "@assets/favicons/favicon.svg";
import {
  getClientRouterFallback,
  getPageTransitionAnimation,
  viewTransitionsEnabled,
} from "@utils/view-transitions";
// Import favicon from public directory instead of assets

interface Props {
  title?: string;
  description?: string;
  image?: string;
  noindex?: boolean;
  wideContent?: boolean;
  article?: boolean;
  canonical?: string;
  publishDate?: Date;
  modifiedDate?: Date;
  author?: {
    name: string;
    url?: string;
  };
  tags?: string[];
  categories?: string[];
  breadcrumbs?: Array<{
    name: string;
    url: string;
  }>;
  preloadImages?: string[];
}

const {
  title = "BitDoze - Web Development Tutorials and Resources",
  description = "Explore web development tutorials, tools, and resources at BitDoze.",
  image = "/images/default-og.jpg",
  noindex = false,
  wideContent = false,
  article = false,
  canonical,
  publishDate,
  modifiedDate,
  author,
  tags,
  categories,
  breadcrumbs,
  preloadImages,
} = Astro.props;

const clientRouterFallback = getClientRouterFallback();
const pageTransition = getPageTransitionAnimation();
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Lightweight theme bootstrapper -->
    <script is:inline>
      (() => {
        const root = document.documentElement;

        const markThemeReady = () => {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              root.classList.remove("theme-preload");
              root.classList.add("theme-ready");
            });
          });
        };

        const applyTheme = () => {
          const stored = localStorage.getItem("theme");
          const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          const isDark = stored === "dark" || (!stored && prefersDark);
          root.classList.toggle("dark", isDark);
          root.style.colorScheme = isDark ? "dark" : "light";
        };

        root.classList.add("theme-preload");
        applyTheme();
        markThemeReady();

        document.addEventListener("astro:after-swap", () => {
          root.classList.add("theme-preload");
          applyTheme();
          markThemeReady();
        });
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href={faviconSVG.src} />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <meta name="generator" content={Astro.generator} />

    <!-- View Transitions -->
    {viewTransitionsEnabled && <ClientRouter fallback={clientRouterFallback} />}

    <!-- Critical CSS to prevent FOUC -->
    <style is:inline>
      /* Critical layout styles */
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .skip-link {
        position: absolute;
        left: -999px;
        top: 1rem;
        background: var(--color-white, #ffffff);
        color: var(--color-gray-900, #111827);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
        z-index: 999;
      }

      .skip-link:focus {
        left: 1rem;
        transform: translateY(0);
      }

      /* Critical prose styles */
      .prose {
        max-width: 65ch;
        color: inherit;
      }
      /* Allow prose containers with max-w-none to be full width */
      .prose.max-w-none,
      .prose.max-w-none\!,
      .prose.\!max-w-none {
        max-width: none !important;
      }
      /* Allow not-prose children to break out of prose max-width */
      .prose > .not-prose {
        max-width: none;
        width: 100%;
      }
      /* Inline widgets like buttons should keep their natural width */
      .prose > a.not-prose,
      .prose > button.not-prose {
        width: auto;
        display: inline-flex;
      }
      .prose img {
        margin: 0 auto;
      }
      .prose p,
      .prose h1,
      .prose h2,
      .prose h3,
      .prose h4,
      .prose h5,
      .prose h6 {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
      }
      .prose pre {
        overflow-x: auto;
        background-color: #f3f4f6;
        border-radius: 0.375rem;
        padding: 1rem;
      }
      .dark .prose pre {
        background-color: #1f2937;
      }
      .dark body {
        background-color: #111827;
        color: #fff;
      }
      main {
        flex: 1 0 auto;
      }
      .max-w-5xl {
        max-width: 64rem;
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem;
        padding-right: 1rem;
      }
      @media (min-width: 640px) {
        .max-w-5xl {
          padding-left: 1.5rem;
          padding-right: 1.5rem;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
      }
    </style>

    <!-- Image Preloading -->
    {
      preloadImages &&
        preloadImages.map((imageUrl) => (
          <link rel="preload" as="image" href={imageUrl} fetchpriority="high" />
        ))
    }

    <!-- SEO Component -->
    <SEO
      title={title}
      description={description}
      image={image}
      article={article}
      noindex={noindex}
      canonical={canonical}
      publishDate={publishDate}
      modifiedDate={modifiedDate}
      author={author}
      tags={tags}
      categories={categories}
      breadcrumbs={breadcrumbs}
    />

    <script
      is:inline
      defer
      data-domain="bitdoze.com"
      data-api="/theone/dra/event"
      src="/theone/dr/script.js"
    ></script>
  </head>

  <body
    class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen flex flex-col"
  >
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <!-- Full-width header -->
    <Header transition:persist />

    <!-- Main content area with conditional width -->
    {pageTransition ? (
      <main
        id="main-content"
        class="grow w-full"
        transition:animate={pageTransition}
      >
        <div class={wideContent ? "w-full" : "max-w-5xl mx-auto px-4 sm:px-6"}>
          <slot />
        </div>
      </main>
    ) : (
      <main id="main-content" class="grow w-full">
        <div class={wideContent ? "w-full" : "max-w-5xl mx-auto px-4 sm:px-6"}>
          <slot />
        </div>
      </main>
    )}

    <!-- Full-width footer -->
    <Footer transition:persist />
  </body>
</html>
