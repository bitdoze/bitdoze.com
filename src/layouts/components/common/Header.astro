---
import ThemeToggle from "./ThemeToggle.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import menu from "@config/menu.json";
import logoSVG from "@assets/favicons/bitdoze_logo_better.svg";
import { getEntrySlug } from "@utils/content";
import { getLocaleFromPathname, getPostLocale, getPostTranslationKey } from "@utils/i18n";
import { isExternalUrl, localizeInternalPath, normalizePath } from "@utils/localeRoutes";

// Extract main menu items
const currentPath = Astro.url.pathname;
const locale = getLocaleFromPathname(currentPath);
const targetLocale = locale === "en" ? "es" : "en";

const ui = locale === "es"
  ? {
      search: "Buscar",
      searchAria: "Buscar",
      openMenu: "Abrir menu principal",
      switchLang: "English",
    }
  : {
      search: "Search",
      searchAria: "Search",
      openMenu: "Open main menu",
      switchLang: "Espanol",
    };

const menuLabelMap: Record<string, string> = {
  Home: "Inicio",
  Resources: "Recursos",
  About: "Acerca de",
  Series: "Series",
  Pages: "Paginas",
  Authors: "Autores",
  Categories: "Categorias",
  Tags: "Etiquetas",
  "Privacy Policy": "Politica de privacidad",
  Tools: "Herramientas",
  "Title Generator": "Generador de titulos",
  "Thumbnail Ideas": "Ideas de miniaturas",
  "YouTube Script": "Guion de YouTube",
  "AI Humanizer": "Humanizador IA",
  Contact: "Contacto",
  Advertise: "Publicidad",
};

const localizeLabel = (label: string): string =>
  locale === "es" ? (menuLabelMap[label] || label) : label;
const localizeUrl = (url: string): string =>
  !url || isExternalUrl(url) ? url : localizeInternalPath(url, locale);

const mainMenu = menu.main.map((item) => ({
  ...item,
  name: localizeLabel(item.name),
  url: localizeUrl(item.url),
  children: item.children?.map((child) => ({
    ...child,
    name: localizeLabel(child.name),
    url: localizeUrl(child.url),
  })),
}));

const allPosts = await getCollection("posts", ({ data }) => !data.draft);
const currentNormalizedPath = normalizePath(currentPath);
const currentPost = allPosts.find((post) => `/${getEntrySlug(post)}/` === currentNormalizedPath);

let languageSwitchPath = localizeInternalPath(currentPath, targetLocale);

if (currentPost) {
  const translationKey = getPostTranslationKey(currentPost);
  const translatedPost = allPosts.find((post) => {
    return (
      getPostTranslationKey(post) === translationKey &&
      getPostLocale(post) === targetLocale
    );
  });

  if (translatedPost) {
    languageSwitchPath = `/${getEntrySlug(translatedPost)}/`;
  }
}
---

<header
  class="header-nav sticky top-0 z-40 w-full backdrop-blur-lg transition-all duration-500 ease-in-out"
  style="background-color: rgba(255, 255, 255, 0.85); border-bottom: 1px solid rgba(0, 0, 0, 0.1);"
>
  <div class="container mx-auto flex h-16 items-center justify-between px-4 sm:px-6 lg:px-8">
    <!-- Logo -->
    <div class="flex shrink-0 items-center">
      <a href={locale === "es" ? "/es/" : "/"} class="logo-link flex items-center gap-2 group">
        <Image
          src={logoSVG}
          alt="BitDoze Logo"
          width={140}
          height={140}
          class="h-8 w-auto transition-transform duration-300 group-hover:scale-105"
        />
      </a>
    </div>

    <!-- Navigation -->
    <nav class="hidden md:flex items-center space-x-2">
      {
        mainMenu.map((item, index) => {
          const submenuId = `desktop-submenu-${index}`;
          if (item.hasChildren) {
            return (
              <div class="relative dropdown">
                <button
                  class="nav-item flex items-center relative px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300 ease-in-out group dropdown-toggle"
                  style="color: rgb(107, 114, 128);"
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls={submenuId}
                >
                  <span class="relative z-10">{item.name}</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="ml-1 h-4 w-4 transition-transform duration-200 dropdown-icon"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                  <div
                    class="nav-bg absolute inset-0 rounded-lg bg-linear-to-r from-transparent via-transparent to-transparent opacity-0 transition-all duration-300 ease-in-out group-hover:opacity-100"
                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));"
                  />
                </button>
                <div id={submenuId} class="absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hidden dropdown-menu transition-all duration-300 opacity-0 z-10 backdrop-blur-lg" style="background-color: rgba(255, 255, 255, 0.95);">
                  <div class="py-1 rounded-md">
                    {item.children.map((child) => (
                      <a
                        href={child.url}
                        class="block px-4 py-2 text-sm text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-200"
                      >
                        {child.name}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            );
          } else if (item.highlight) {
            // Special highlighted link (Advertise) - matches hero CTA style
            return (
              <a
                href={item.url}
                class="nav-item-highlight relative px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-300 ease-in-out group overflow-hidden bg-linear-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white shadow-md hover:shadow-lg"
              >
                <span class="relative z-10 flex items-center gap-1.5">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                  </svg>
                  {item.name}
                </span>
              </a>
            );
          } else {
            const isActive =
              currentPath === item.url ||
              (item.url !== "/" && currentPath.startsWith(item.url + "/")) ||
              (item.url !== "/" && currentPath === item.url);
            return (
              <a
                href={item.url}
                class="nav-item relative px-4 py-2 text-sm font-medium rounded-lg transition-all duration-300 ease-in-out group"
                style="color: rgb(107, 114, 128);"
                aria-current={isActive ? "page" : undefined}
                data-active={isActive ? "true" : "false"}
              >
                <span class="relative z-10">{item.name}</span>
                <div
                  class="nav-bg absolute inset-0 rounded-lg bg-linear-to-r from-transparent via-transparent to-transparent opacity-0 transition-all duration-300 ease-in-out group-hover:opacity-100"
                  style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));"
                />
                <div
                  class="nav-indicator absolute bottom-0 left-1/2 h-0.5 w-0 rounded-full transition-all duration-300 ease-in-out group-hover:w-3/4 group-hover:-translate-x-1/2"
                  style="background-color: rgb(59, 130, 246);"
                />
              </a>
            );
          }
        })
      }
      <!-- Search Icon -->
      <a
        href={localizeInternalPath("/search/", locale)}
        class="nav-item relative p-2 rounded-lg transition-all duration-300 ease-in-out group"
        style="color: rgb(107, 114, 128);"
        aria-label={ui.searchAria}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 relative z-10"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <div
          class="nav-bg absolute inset-0 rounded-lg bg-linear-to-r from-transparent via-transparent to-transparent opacity-0 transition-all duration-300 ease-in-out group-hover:opacity-100"
          style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));"
        />
      </a>
      <a
        href={languageSwitchPath}
        class="nav-item relative px-3 py-2 text-xs font-semibold rounded-lg transition-all duration-300 ease-in-out group border border-gray-200 dark:border-gray-700"
        style="color: rgb(107, 114, 128);"
        aria-label={ui.switchLang}
      >
        <span class="relative z-10">{targetLocale.toUpperCase()}</span>
      </a>
      <ThemeToggle id="themeToggle-desktop" />
    </nav>

    <!-- Mobile menu button -->
    <div class="flex md:hidden items-center gap-2">
      <ThemeToggle id="themeToggle-mobile-header" />
      <button
        type="button"
        id="mobile-menu-button"
        aria-expanded="false"
        aria-controls="mobile-menu"
        class="mobile-menu-btn inline-flex items-center justify-center p-3 rounded-lg min-h-12 min-w-12 transition-all duration-300 ease-in-out hover:scale-105 active:scale-95 focus:outline-none"
        style="background-color: rgba(0, 0, 0, 0.05); backdrop-filter: blur(8px);"
      >
        <span class="sr-only">{ui.openMenu}</span>
        <div class="hamburger relative w-6 h-6 flex flex-col justify-center items-center">
          <span
            class="hamburger-line w-5 h-0.5 rounded-full transition-all duration-300"
            style="background-color: rgb(107, 114, 128); transform: translateY(-2px);"
          ></span>
          <span
            class="hamburger-line w-5 h-0.5 rounded-full transition-all duration-300 mt-1"
            style="background-color: rgb(107, 114, 128);"></span>
          <span
            class="hamburger-line w-5 h-0.5 rounded-full transition-all duration-300 mt-1"
            style="background-color: rgb(107, 114, 128); transform: translateY(2px);"
          ></span>
        </div>
      </button>
    </div>
  </div>

  <!-- Mobile menu -->
  <div
    id="mobile-menu"
    class="mobile-menu fixed top-16 left-0 right-0 hidden md:hidden transition-all duration-500 ease-in-out transform -translate-y-2 opacity-0 z-50"
    style="display: none; background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9)); backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); border-top: 1px solid rgba(0, 0, 0, 0.1);"
  >
    <div class="space-y-1 p-6">
      {
        mainMenu.map((item, index) => {
          const submenuId = `mobile-submenu-${index}`;
          if (item.hasChildren) {
            return (
              <div class="mobile-dropdown">
                <button class="mobile-dropdown-button group flex w-full px-4 py-4 text-base font-medium rounded-xl transition-all duration-300 min-h-12 items-center justify-between relative overflow-hidden" style={`transition: all 0.3s; animation-delay: ${index * 50}ms;`} aria-expanded="false" aria-controls={submenuId}>
                  <span class="relative z-10 transition-transform duration-300 group-hover:translate-x-1">
                    {item.name}
                  </span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="mobile-dropdown-icon w-5 h-5 transition-all duration-300"
                    style="color: rgb(59, 130, 246);"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                  <div
                    class="absolute inset-0 bg-linear-to-r opacity-0 transition-all duration-300 rounded-xl group-hover:opacity-100"
                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));"
                  />
                </button>
                <div id={submenuId} class="mobile-dropdown-content hidden pl-4 py-2 space-y-1">
                  {item.children.map((child) => (
                    <a
                      href={child.url}
                      class="mobile-menu-item group flex px-4 py-3 text-base font-medium rounded-xl transition-all duration-300 min-h-12 items-center justify-between relative overflow-hidden"
                    >
                      <span class="relative z-10 transition-transform duration-300 group-hover:translate-x-1">
                        {child.name}
                      </span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 opacity-0 transition-all duration-300 group-hover:opacity-100 group-hover:translate-x-1"
                        style="color: rgb(59, 130, 246);"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 5l7 7-7 7"
                        />
                      </svg>
                      <div
                        class="absolute inset-0 bg-linear-to-r opacity-0 transition-all duration-300 rounded-xl group-hover:opacity-100"
                        style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));"
                      />
                    </a>
                  ))}
                </div>
              </div>
            );
          } else if (item.highlight) {
            // Special highlighted link (Advertise) for mobile - matches hero CTA style
            return (
              <a
                href={item.url}
                class="mobile-menu-item-highlight group flex px-4 py-4 text-base font-semibold rounded-xl transition-all duration-300 min-h-12 items-center justify-between relative overflow-hidden bg-linear-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white shadow-md"
                style={`transition: all 0.3s; animation-delay: ${index * 50}ms;`}
              >
                <span class="relative z-10 transition-transform duration-300 group-hover:translate-x-1 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                  </svg>
                  {item.name}
                </span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 opacity-70 transition-all duration-300 group-hover:opacity-100 group-hover:translate-x-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            );
          } else {
            const isActive =
              currentPath === item.url ||
              (item.url !== "/" && currentPath.startsWith(item.url + "/")) ||
              (item.url !== "/" && currentPath === item.url);
            return (
              <a
                href={item.url}
                class="mobile-menu-item group flex px-4 py-4 text-base font-medium rounded-xl transition-all duration-300 min-h-12 items-center justify-between relative overflow-hidden"
                style={`transition: all 0.3s; animation-delay: ${index * 50}ms;`}
                aria-current={isActive ? "page" : undefined}
                data-active={isActive ? "true" : "false"}
              >
                <span class="relative z-10 transition-transform duration-300 group-hover:translate-x-1">
                  {item.name}
                </span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 opacity-0 transition-all duration-300 group-hover:opacity-100 group-hover:translate-x-1"
                  style="color: rgb(59, 130, 246);"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
                <div
                  class="absolute inset-0 bg-linear-to-r opacity-0 transition-all duration-300 rounded-xl group-hover:opacity-100"
                  style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));"
                />
              </a>
            );
          }
        })
      }
      <a
        href={localizeInternalPath("/search/", locale)}
        class="mobile-menu-item group flex px-4 py-4 text-base font-medium rounded-xl transition-all duration-300 min-h-12 items-center justify-between relative overflow-hidden"
      >
        <span class="relative z-10 transition-transform duration-300 group-hover:translate-x-1 flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          {ui.search}
        </span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-5 h-5 opacity-0 transition-all duration-300 group-hover:opacity-100 group-hover:translate-x-1"
          style="color: rgb(59, 130, 246);"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"
          />
        </svg>
        <div
          class="absolute inset-0 bg-linear-to-r opacity-0 transition-all duration-300 rounded-xl group-hover:opacity-100"
          style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));"
        />
      </a>
      <a
        href={languageSwitchPath}
        class="mobile-menu-item group flex px-4 py-4 text-base font-medium rounded-xl transition-all duration-300 min-h-12 items-center justify-between relative overflow-hidden"
      >
        <span class="relative z-10 transition-transform duration-300 group-hover:translate-x-1">
          {targetLocale === "es" ? "Cambiar a Espanol" : "Switch to English"}
        </span>
      </a>
    </div>
  </div>
</header>

<script>
  (() => {
    const win = window as typeof window & { __bitdozeHeaderInitialized?: boolean };
    if (win.__bitdozeHeaderInitialized) return;
    win.__bitdozeHeaderInitialized = true;

    function initHeader() {
      const menuButton = document.getElementById("mobile-menu-button");
      const mobileMenu = document.getElementById("mobile-menu");

      if (menuButton && !menuButton.dataset.menuInitialized && mobileMenu) {
        menuButton.dataset.menuInitialized = "true";

        const toggleMobileMenu = () => {
          const lines = menuButton.querySelectorAll(".hamburger-line");
          const [lineTop, lineMiddle, lineBottom] = Array.from(lines);
          const expanded = menuButton.getAttribute("aria-expanded") === "true";
          const isOpening = !expanded;

          menuButton.setAttribute("aria-expanded", String(isOpening));

          if (isOpening) {
            mobileMenu.style.display = "block";
            mobileMenu.classList.remove("hidden");
            requestAnimationFrame(() => {
              mobileMenu.classList.remove("-translate-y-2", "opacity-0");
              mobileMenu.classList.add("translate-y-0", "opacity-100");
            });

            if (lineTop instanceof HTMLElement) {
              lineTop.style.transform = "rotate(45deg) translateY(3px)";
            }
            if (lineMiddle instanceof HTMLElement) {
              lineMiddle.style.opacity = "0";
            }
            if (lineBottom instanceof HTMLElement) {
              lineBottom.style.transform = "rotate(-45deg) translateY(-3px)";
            }
          } else {
            mobileMenu.classList.remove("translate-y-0", "opacity-100");
            mobileMenu.classList.add("-translate-y-2", "opacity-0");

            if (lineTop instanceof HTMLElement) {
              lineTop.style.transform = "translateY(-2px)";
            }
            if (lineMiddle instanceof HTMLElement) {
              lineMiddle.style.opacity = "1";
            }
            if (lineBottom instanceof HTMLElement) {
              lineBottom.style.transform = "translateY(2px)";
            }

            setTimeout(() => {
              mobileMenu.classList.add("hidden");
              mobileMenu.style.display = "none";
            }, 500);
          }
        };

        menuButton.addEventListener("click", toggleMobileMenu);

        const mobileMenuItems = mobileMenu.querySelectorAll(".mobile-menu-item");
        mobileMenuItems.forEach((item) => {
          item.addEventListener("click", () => {
            if (menuButton.getAttribute("aria-expanded") === "true") {
              toggleMobileMenu();
            }
          });
        });
      }

      const mobileDropdownButtons = document.querySelectorAll(
        ".mobile-dropdown-button"
      );

      mobileDropdownButtons.forEach((button) => {
        if (button instanceof HTMLElement && !button.dataset.dropdownInitialized) {
          button.dataset.dropdownInitialized = "true";
          button.addEventListener("click", () => {
            const content = button.nextElementSibling;
            const icon = button.querySelector(".mobile-dropdown-icon");
            const expanded = button.getAttribute("aria-expanded") === "true";

            if (content instanceof HTMLElement) {
              content.classList.toggle("hidden");
            }
            if (icon instanceof HTMLElement) {
              icon.classList.toggle("rotate-180");
            }
            button.setAttribute("aria-expanded", String(!expanded));
          });
        }
      });

      const header = document.querySelector(".header-nav");
      if (header instanceof HTMLElement && !header.dataset.scrollInitialized) {
        header.dataset.scrollInitialized = "true";
        window.addEventListener("scroll", () => {
          const scrollY = window.scrollY;

          if (scrollY > 100) {
            header.style.backgroundColor = "rgba(255, 255, 255, 0.95)";
            header.style.boxShadow = "0 4px 20px rgba(0, 0, 0, 0.1)";
          } else {
            header.style.backgroundColor = "rgba(255, 255, 255, 0.85)";
            header.style.boxShadow = "none";
          }
        }, { passive: true });
      }

      const dropdownToggles = document.querySelectorAll(".dropdown-toggle");

      const closeAllDropdowns = () => {
        document.querySelectorAll(".dropdown-menu").forEach((menu) => {
          menu.classList.add("hidden");
          menu.classList.remove("opacity-100");
          menu.classList.add("opacity-0");
        });
        dropdownToggles.forEach((toggle) => {
          toggle.setAttribute("aria-expanded", "false");
          const icon = toggle.querySelector(".dropdown-icon");
          if (icon instanceof HTMLElement) {
            icon.classList.remove("rotate-180");
          }
        });
      };

      document.addEventListener("click", (event) => {
        const target = event.target;
        if (target instanceof Element && !target.closest(".dropdown")) {
          closeAllDropdowns();
        }
      });

      dropdownToggles.forEach((toggle) => {
        if (!toggle.hasAttribute("data-dropdown-initialized")) {
          toggle.setAttribute("data-dropdown-initialized", "true");

          toggle.addEventListener("click", (event) => {
            event.stopPropagation();
            const dropdown = toggle.closest(".dropdown");
            if (!(dropdown instanceof HTMLElement)) return;

            const menu = dropdown.querySelector(".dropdown-menu");
            const icon = toggle.querySelector(".dropdown-icon");
            const isExpanded = toggle.getAttribute("aria-expanded") === "true";

            dropdownToggles.forEach((otherToggle) => {
              if (otherToggle !== toggle) {
                otherToggle.setAttribute("aria-expanded", "false");
                const otherIcon = otherToggle.querySelector(".dropdown-icon");
                if (otherIcon instanceof HTMLElement) {
                  otherIcon.classList.remove("rotate-180");
                }
                const otherDropdown = otherToggle.closest(".dropdown");
                if (otherDropdown instanceof HTMLElement) {
                  const otherMenu = otherDropdown.querySelector(
                    ".dropdown-menu"
                  );
                  if (otherMenu instanceof HTMLElement) {
                    otherMenu.classList.add("hidden");
                    otherMenu.classList.remove("opacity-100");
                    otherMenu.classList.add("opacity-0");
                  }
                }
              }
            });

            if (isExpanded) {
              toggle.setAttribute("aria-expanded", "false");
              if (menu instanceof HTMLElement) {
                menu.classList.add("hidden");
                menu.classList.remove("opacity-100");
                menu.classList.add("opacity-0");
              }
              if (icon instanceof HTMLElement) {
                icon.classList.remove("rotate-180");
              }
            } else {
              toggle.setAttribute("aria-expanded", "true");
              if (menu instanceof HTMLElement) {
                menu.classList.remove("hidden");
                setTimeout(() => {
                  if (menu instanceof HTMLElement) {
                    menu.classList.remove("opacity-0");
                    menu.classList.add("opacity-100");
                  }
                }, 10);
              }
              if (icon instanceof HTMLElement) {
                icon.classList.add("rotate-180");
              }
            }
          });

          toggle.addEventListener("keydown", (event) => {
            if (event instanceof KeyboardEvent) {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                toggle.dispatchEvent(new Event("click", { bubbles: true }));
              } else if (event.key === "Escape") {
                closeAllDropdowns();
              }
            }
          });
        }
      });
    }

    const ensureHeaderInit = () => {
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initHeader, { once: true });
      } else {
        initHeader();
      }
    };

    ensureHeaderInit();
    document.addEventListener("astro:page-load", initHeader);

    document.addEventListener("astro:after-swap", () => {
      const menuButton = document.getElementById("mobile-menu-button");
      const mobileMenu = document.getElementById("mobile-menu");
      if (!menuButton || !mobileMenu) return;

      menuButton.setAttribute("aria-expanded", "false");
      mobileMenu.classList.add("hidden", "-translate-y-2", "opacity-0");
      mobileMenu.classList.remove("translate-y-0", "opacity-100");
      mobileMenu.style.display = "none";

      const lines = menuButton.querySelectorAll(".hamburger-line");
      const [lineTop, lineMiddle, lineBottom] = Array.from(lines);
      if (lineTop instanceof HTMLElement) {
        lineTop.style.transform = "translateY(-2px)";
      }
      if (lineMiddle instanceof HTMLElement) {
        lineMiddle.style.opacity = "1";
      }
      if (lineBottom instanceof HTMLElement) {
        lineBottom.style.transform = "translateY(2px)";
      }
    });
  })();
</script>

<style>
  /* Header enhancements */
  .header-nav {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    height: 64px;
    min-height: 64px;
    max-height: 64px;
    overflow: visible;
  }

  /* Ensure mobile menu doesn't affect desktop */
  @media (min-width: 768px) {
    .mobile-menu {
      display: none !important;
    }
  }

  /* Logo animation */
  .logo-link {
    transition: all 0.3s ease;
  }

  .logo-link:hover {
    filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.3));
  }

  /* Navigation item enhancements */
  .nav-item {
    position: relative;
    overflow: hidden;
  }

  .nav-item:hover {
    color: rgb(59, 130, 246);
    transform: translateY(-1px);
  }

  .nav-item:active {
    transform: translateY(0);
  }

  /* Highlighted nav item (Advertise button) - consistent with site design */
  .nav-item-highlight {
    position: relative;
    overflow: hidden;
  }

  .nav-item-highlight:hover {
    transform: scale(1.05);
  }

  .nav-item-highlight:active {
    transform: scale(1);
  }

  /* Highlighted mobile menu item (Advertise button) */
  .mobile-menu-item-highlight {
    position: relative;
    overflow: hidden;
    margin-top: 8px;
  }

  .mobile-menu-item-highlight:hover {
    transform: translateX(4px);
  }

  .mobile-menu-item-highlight:active {
    transform: translateX(2px) scale(0.98);
  }

  /* Active state for current page */
  .nav-item[data-active="true"] {
    color: rgb(59, 130, 246);
  }
  .nav-item[data-active="true"] .nav-indicator {
    width: 75%;
    left: 50%;
    transform: translateX(-50%);
    height: 2px;
  }

  /* Mobile menu enhancements */
  .mobile-menu {
    max-height: calc(100vh - 64px);
    overflow-y: auto;
    /* Optimize rendering when hidden */
    content-visibility: auto;
    contain-intrinsic-size: 0 500px;
  }

  /* Ensure mobile menu starts hidden */
  .mobile-menu.hidden {
    display: none !important;
    content-visibility: hidden;
  }

  @media (min-width: 768px) {
    .mobile-menu {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      overflow: hidden !important;
      content-visibility: hidden;
    }
  }

  .mobile-menu-item {
    position: relative;
    overflow: hidden;
  }

  .mobile-menu-item:hover {
    color: rgb(59, 130, 246);
    transform: translateX(4px);
  }

  .mobile-menu-item:active {
    transform: translateX(2px) scale(0.98);
  }

  .mobile-menu-item[data-active="true"] {
    color: rgb(59, 130, 246);
    font-weight: 600;
  }

  /* Mobile menu button */
  .mobile-menu-btn:hover {
    background-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  /* Hamburger animation */
  .hamburger-line {
    transform-origin: center;
  }

  /* Dark mode adjustments */
  :global(.dark) .header-nav {
    background-color: rgba(17, 24, 39, 0.85) !important;
    border-bottom-color: rgba(255, 255, 255, 0.1) !important;
  }

  :global(.dark) .mobile-menu {
    background: linear-gradient(
      135deg,
      rgba(17, 24, 39, 0.95),
      rgba(17, 24, 39, 0.9)
    ) !important;
    border-top-color: rgba(255, 255, 255, 0.1) !important;
  }

  :global(.dark) .mobile-menu-btn {
    background-color: rgba(255, 255, 255, 0.05) !important;
  }

  :global(.dark) .mobile-menu-btn:hover {
    background-color: rgba(255, 255, 255, 0.1) !important;
  }

  :global(.dark) .dropdown-menu {
    background-color: rgba(31, 41, 55, 0.95) !important;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .mobile-menu-item {
      animation: slideInFromRight 0.3s ease-out forwards;
      opacity: 0;
      transform: translateX(20px);
    }
  }

  @keyframes slideInFromRight {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Smooth scrolling improvements */
  @media (prefers-reduced-motion: no-preference) {
    .nav-item,
    .mobile-menu-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
  }

  /* Focus states for accessibility */
  .nav-item:focus-visible,
  .mobile-menu-item:focus-visible {
    outline: 2px solid rgb(59, 130, 246);
    outline-offset: 2px;
  }
</style>
