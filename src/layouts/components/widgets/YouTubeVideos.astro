---
import { Icon } from "astro-icon/components";
import { Image } from 'astro:assets';

// Fetch YouTube RSS feed at build time
const response = await fetch(
  "https://www.youtube.com/feeds/videos.xml?channel_id=UCGsUtKhXsRrMvYAWm8q0bCg"
);
const xmlText = await response.text();

// Parse XML to extract video data
const videoRegex =
  /<entry>.*?<yt:videoId>(.*?)<\/yt:videoId>.*?<title>(.*?)<\/title>.*?<published>(.*?)<\/published>.*?<\/entry>/gs;
const videos = [];
let match;

while ((match = videoRegex.exec(xmlText)) !== null && videos.length < 6) {
  const [, videoId, title, published] = match;
  videos.push({
    id: videoId,
    title: title
      .replace(/&amp;/g, "&")
      .replace(/&lt;/g, "<")
      .replace(/&gt;/g, ">")
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'"),
    published: new Date(published),
    thumbnail: `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`,
    url: `https://www.youtube.com/watch?v=${videoId}`,
  });
}
---

<section class="py-8 bg-white dark:bg-gray-900 rounded-lg">
  <div class="max-w-5xl mx-auto px-4 sm:px-6">
    <div class="text-center mb-8">
      <h2
        class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-4"
      >
        Latest YouTube Videos
      </h2>
      <p class="text-lg text-gray-600 dark:text-gray-300">
        Check out our latest content on YouTube
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 justify-items-center">
      {
        videos.map((video) => (
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 border border-gray-200 dark:border-gray-700 p-3 w-72">
            <div class="relative">
              <a href={video.url} target="_blank" rel="noopener noreferrer">
                <Image
                  src={`https://img.youtube.com/vi/${video.id}/maxresdefault.jpg`}
                  alt={video.title}
                  width={300}
                  height={165}
                  class="w-full rounded"
                  loading="lazy"
                  format="webp"
                />
              </a>
              <a href={video.url} target="_blank" rel="noopener noreferrer">
                <Icon
                  name="mdi:play-circle"
                  class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white w-12 h-12 drop-shadow-lg opacity-80 hover:opacity-100 transition-opacity"
                />
              </a>
            </div>
            <div class="mt-3">
              <a href={video.url} target="_blank" rel="noopener noreferrer">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white line-clamp-2 mb-2 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                  {video.title}
                </h3>
              </a>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                {video.published.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
              </p>
            </div>
          </div>
        ))
      }
    </div>

    <div class="text-center mt-8">
      <a
        href="https://www.youtube.com/channel/UCGsUtKhXsRrMvYAWm8q0bCg"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-300"
      >
        <Icon name="mdi:youtube" class="w-5 h-5 mr-2" />
        View All Videos
      </a>
    </div>
  </div>
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
