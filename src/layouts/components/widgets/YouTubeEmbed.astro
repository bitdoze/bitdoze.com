---
/**
 * Lightweight YouTube Embed Component
 * Uses facade pattern: shows thumbnail + play button, loads iframe only on interaction
 * Significantly improves Core Web Vitals by deferring ~1MB of YouTube JS
 */
import {
  extractYoutubeVideoId,
  getYoutubeEmbedUrl,
  getYoutubeThumbnailSync,
} from "@utils/youtube";

interface Props {
  url: string;
  label: string;
  className?: string;
  description?: string;
  uploadDate?: string | Date;
  duration?: string;
}

const { url, label, className, description, uploadDate, duration } = Astro.props;

const embedUrl = getYoutubeEmbedUrl(url);
const thumbnail = getYoutubeThumbnailSync(url);
const isPlayable = Boolean(embedUrl);
const ariaLabel = isPlayable ? `Play video: ${label}` : "YouTube video unavailable";
const videoId = extractYoutubeVideoId(url);
const schemaEmbedUrl = videoId ? `https://www.youtube.com/embed/${videoId}` : null;
const contentUrl = videoId ? `https://www.youtube.com/watch?v=${videoId}` : null;
let uploadDateIso: string | undefined;
if (uploadDate) {
  const parsedDate = new Date(uploadDate);
  uploadDateIso = Number.isNaN(parsedDate.getTime())
    ? undefined
    : parsedDate.toISOString();
}

const videoSchema =
  isPlayable && videoId
    ? {
        "@context": "https://schema.org",
        "@type": "VideoObject",
        name: label,
        description: description || label,
        thumbnailUrl: thumbnail,
        uploadDate: uploadDateIso,
        duration,
        embedUrl: schemaEmbedUrl,
        contentUrl,
      }
    : null;
---

<div
  class:list={["yt-facade relative aspect-video w-full overflow-hidden rounded-lg bg-gray-900", className]}
  data-youtube-video
>
  <button
    type="button"
    class="yt-trigger absolute inset-0 flex h-full w-full cursor-pointer items-center justify-center border-0 bg-transparent p-0"
    data-youtube-trigger
    aria-label={ariaLabel}
    data-embed-url={isPlayable ? embedUrl : undefined}
    disabled={!isPlayable}
    data-video-title={label}
  >
    {/* Thumbnail Image - Using native img for compatibility with playlists and remote URLs */}
    <img
      src={thumbnail}
      alt={label}
      width="1280"
      height="720"
      loading="lazy"
      decoding="async"
      class="h-full w-full object-cover"
    />

    {/* Play Button Overlay */}
    <span class="yt-play-btn pointer-events-none absolute inset-0 flex items-center justify-center">
      <svg
        class="h-16 w-16 text-white drop-shadow-lg transition-transform duration-200 sm:h-20 sm:w-20"
        viewBox="0 0 68 48"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        {/* YouTube-style rounded rectangle background */}
        <path
          d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z"
          fill="#FF0000"
        />
        {/* Play triangle */}
        <path
          d="M45 24L27 14v20l18-10z"
          fill="white"
        />
      </svg>
    </span>

    {/* Gradient overlay for better button visibility */}
    <span class="pointer-events-none absolute inset-0 bg-linear-to-t from-black/30 via-transparent to-transparent"></span>
  </button>
</div>

{videoSchema && (
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(videoSchema)}
  />
)}

<script>
  // Use event delegation for reliable mobile support
  // This runs once and handles all YouTube embeds on the page
  declare global {
    interface Window {
      __ytEmbedInit?: boolean;
    }
  }
  
  if (typeof window !== 'undefined' && !window.__ytEmbedInit) {
    window.__ytEmbedInit = true;
    
    const activateVideo = (trigger: HTMLButtonElement) => {
      const root = trigger.closest('[data-youtube-video]');
      if (!root) return;
      
      const embedUrl = trigger.dataset.embedUrl;
      const title = trigger.dataset.videoTitle || "YouTube video player";
      if (!embedUrl) return;

      // Create iframe element
      const iframe = document.createElement("iframe");
      iframe.src = embedUrl;
      iframe.title = title;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
      iframe.allowFullscreen = true;
      iframe.loading = "lazy";
      iframe.referrerPolicy = "strict-origin-when-cross-origin";
      iframe.className = "absolute inset-0 h-full w-full border-0";

      // Replace content with iframe
      root.replaceChildren(iframe);
    };

    // Use event delegation for clicks - works reliably on mobile
    document.addEventListener('click', (event) => {
      const trigger = (event.target as Element)?.closest('[data-youtube-trigger]');
      if (trigger instanceof HTMLButtonElement && trigger.dataset.embedUrl) {
        event.preventDefault();
        activateVideo(trigger);
      }
    });

    // Handle touch events explicitly for mobile
    document.addEventListener('touchend', (event) => {
      const trigger = (event.target as Element)?.closest('[data-youtube-trigger]');
      if (trigger instanceof HTMLButtonElement && trigger.dataset.embedUrl) {
        event.preventDefault();
        activateVideo(trigger);
      }
    }, { passive: false });

    // Keyboard activation (Enter and Space for accessibility)
    document.addEventListener('keydown', (event) => {
      if (event.key === "Enter" || event.key === " ") {
        const trigger = (event.target as Element)?.closest('[data-youtube-trigger]');
        if (trigger instanceof HTMLButtonElement && trigger.dataset.embedUrl) {
          event.preventDefault();
          activateVideo(trigger);
        }
      }
    });
  }
</script>

<style>
  .yt-facade {
    background-color: #000;
  }

  .yt-trigger:hover .yt-play-btn svg {
    transform: scale(1.1);
  }

  .yt-trigger:focus-visible {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  .yt-trigger:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .yt-trigger:disabled .yt-play-btn svg path:first-child {
    fill: #666;
  }
</style>
