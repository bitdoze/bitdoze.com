---
export interface Props {
  label: string;
  group: string;
  expanded?: string;
}

const { label, group, expanded = "false" } = Astro.props;
const isExpanded = expanded === "true";
const accordionId = `accordion-${label
  .replace(/\s+/g, "-")
  .toLowerCase()}-${Math.random().toString(36).substring(2, 9)}`;
---

<div
  class="not-prose accordion-item my-6 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-200"
>
  <h3>
    <button
      id={`${accordionId}-header`}
      class="accordion-header flex justify-between items-center w-full p-4 sm:p-5 text-left bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-inset"
      aria-expanded={isExpanded}
      aria-controls={`${accordionId}-panel`}
      data-accordion-target={`${accordionId}-panel`}
      data-group={group}
    >
      <span
        class="font-semibold text-base sm:text-lg text-gray-900 dark:text-white pr-4"
        >{label}</span
      >
      <svg
        class="w-5 h-5 sm:w-6 sm:h-6 transition-transform duration-200 text-gray-500 dark:text-gray-400 shrink-0"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
  </h3>
  <div
    id={`${accordionId}-panel`}
    class="accordion-panel overflow-hidden transition-all duration-300 max-h-0"
    aria-labelledby={`${accordionId}-header`}
    role="region"
  >
    <div
      class="p-4 sm:p-6 bg-white dark:bg-gray-900 prose dark:prose-invert prose-lg max-w-none"
    >
      <slot />
    </div>
  </div>
</div>

<script>
  // Initialize accordions
  function initAccordions() {
    document.querySelectorAll(".accordion-header").forEach((headerEl) => {
      const header = headerEl as HTMLButtonElement;
      const targetId = header.getAttribute("data-accordion-target");
      if (!targetId) {
        return;
      }
      const panel = document.getElementById(targetId);
      const isExpanded = header.getAttribute("aria-expanded") === "true";

      // Set initial state
      if (isExpanded && panel) {
        panel.style.maxHeight = panel.scrollHeight + "px";
        header.querySelector("svg")?.classList.add("rotate-180");
      }

      // Remove existing event listener to prevent duplicates
      header.removeEventListener("click", toggleAccordion);

      // Add click event listener
      header.addEventListener("click", toggleAccordion);
    });

    // Handle content changes that might affect height
    window.addEventListener("resize", updateExpandedPanels);
  }

  // Function to toggle accordion state
  function toggleAccordion(this: HTMLButtonElement) {
    const header = this;
    const isCurrentlyExpanded = header.getAttribute("aria-expanded") === "true";
    const group = header.getAttribute("data-group");
    const targetId = header.getAttribute("data-accordion-target");
    if (!targetId) {
      return;
    }
    const currentPanel = document.getElementById(targetId);

    // Close other accordions in the same group
    if (group && !isCurrentlyExpanded) {
      document
        .querySelectorAll(`.accordion-header[data-group="${group}"]`)
        .forEach((groupHeader) => {
          if (
            groupHeader !== header &&
            groupHeader.getAttribute("aria-expanded") === "true"
          ) {
            const groupPanelId = groupHeader.getAttribute(
              "data-accordion-target"
            );
            if (!groupPanelId) {
              return;
            }
            const groupPanel = document.getElementById(groupPanelId);
            groupHeader.setAttribute("aria-expanded", "false");
            groupHeader.querySelector("svg")?.classList.remove("rotate-180");
            if (groupPanel) groupPanel.style.maxHeight = "0px";
          }
        });
    }

    // Toggle current accordion
    header.setAttribute(
      "aria-expanded",
      !isCurrentlyExpanded ? "true" : "false"
    );
    header.querySelector("svg")?.classList.toggle("rotate-180");

    if (currentPanel) {
      if (isCurrentlyExpanded) {
        currentPanel.style.maxHeight = "0px";
      } else {
        currentPanel.style.maxHeight = `${currentPanel.scrollHeight}px`;
      }
    }
  }

  // Function to update heights of expanded panels
  function updateExpandedPanels() {
    document
      .querySelectorAll('.accordion-header[aria-expanded="true"]')
      .forEach((header) => {
        const targetId = header.getAttribute("data-accordion-target");
        if (!targetId) {
          return;
        }
        const panel = document.getElementById(targetId);
        if (panel) {
          panel.style.maxHeight = `${panel.scrollHeight}px`;
        }
      });
  }

  // Run initialization functions at various lifecycle points
  document.addEventListener("DOMContentLoaded", initAccordions);
  document.addEventListener("astro:after-swap", initAccordions);
  document.addEventListener("astro:page-load", initAccordions);

  // Initialize immediately if the document is already interactive
  if (
    document.readyState === "complete" ||
    document.readyState === "interactive"
  ) {
    setTimeout(initAccordions, 1);
  }

  // Also add a window load event for good measure
  window.addEventListener("load", initAccordions);
</script>

<style>
  .accordion-item {
    width: 100%;
    max-width: none;
  }

  .accordion-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
  }

  .accordion-header svg.rotate-180 {
    transform: rotate(180deg);
  }

  /* Ensure proper content styling within accordion */
  .accordion-panel :global(h1),
  .accordion-panel :global(h2),
  .accordion-panel :global(h3),
  .accordion-panel :global(h4),
  .accordion-panel :global(h5),
  .accordion-panel :global(h6) {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    width: 100%;
  }

  .accordion-panel :global(h1:first-child),
  .accordion-panel :global(h2:first-child),
  .accordion-panel :global(h3:first-child),
  .accordion-panel :global(h4:first-child),
  .accordion-panel :global(h5:first-child),
  .accordion-panel :global(h6:first-child) {
    margin-top: 0;
  }

  .accordion-panel :global(p) {
    margin-bottom: 1rem;
    width: 100%;
  }

  .accordion-panel :global(p:last-child) {
    margin-bottom: 0;
  }

  .accordion-panel :global(ul),
  .accordion-panel :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
    width: 100%;
  }

  .accordion-panel :global(li) {
    margin-bottom: 0.5rem;
    width: 100%;
  }

  .accordion-panel :global(pre) {
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    width: 100%;
  }

  .accordion-panel :global(code) {
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  .accordion-panel :global(blockquote) {
    margin: 1rem 0;
    padding-left: 1rem;
    border-left: 4px solid #d1d5db;
    width: 100%;
  }

  :global(.dark) .accordion-panel :global(blockquote) {
    border-left-color: #6b7280;
  }

  /* Ensure text content uses full width */
  .accordion-panel :global(*) {
    max-width: none;
  }

  .accordion-panel :global(div),
  .accordion-panel :global(span) {
    width: 100%;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .accordion-header span {
      font-size: 1rem;
    }

    .accordion-panel :global(.prose) {
      font-size: 0.875rem;
      line-height: 1.625;
    }
  }

  /* Smooth hover effects */
  .accordion-item:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  :global(.dark) .accordion-item:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3),
      0 2px 4px -1px rgba(0, 0, 0, 0.2);
  }
</style>
