---
import type { MarkdownHeading } from "astro";
import type { Heading } from "./TOCHeading.astro";
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import { getEntryHref, getEntrySlug } from '@utils/content';

interface Props {
  headings: MarkdownHeading[];
  currentPost?: CollectionEntry<'posts'>;
}

function buildToc(headings: MarkdownHeading[]) {
  const toc: Heading[] = [];
  const parentHeadings = new Map();
  headings
    .filter((h) => h.depth <= 3)
    .forEach((h) => {
      const heading = { ...h, subheadings: [] };
      parentHeadings.set(heading.depth, heading);
      if (heading.depth === 2) {
        toc.push(heading);
      } else {
        parentHeadings.get(heading.depth - 1)?.subheadings.push(heading);
      }
    });
  return toc;
}

function shuffleArray<T>(array: T[]): T[] {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
}

function getRelatedPosts(currentPost: CollectionEntry<'posts'>, otherPosts: CollectionEntry<'posts'>[], limit: number): CollectionEntry<'posts'>[] {
  const postsByTags = otherPosts.filter(post => {
    const postTags = post.data.tags || [];
    const currentTags = currentPost.data.tags || [];
    return currentTags.some((tag: string) => postTags.includes(tag));
  });

  if (postsByTags.length >= limit) {
    return shuffleArray(postsByTags).slice(0, limit);
  }

  const postsByCategories = otherPosts.filter(post => {
    const postCategories = post.data.categories || [];
    const currentCategories = currentPost.data.categories || [];
    return currentCategories.some((category: string) => postCategories.includes(category));
  });

  const combinedPosts = [...postsByTags];
  postsByCategories.forEach(post => {
    if (!combinedPosts.some(p => getEntrySlug(p) === getEntrySlug(post))) {
      combinedPosts.push(post);
    }
  });

  if (combinedPosts.length >= limit) {
    return shuffleArray(combinedPosts).slice(0, limit);
  }

  const remainingPosts = otherPosts.filter(post =>
    !combinedPosts.some((p) => getEntrySlug(p) === getEntrySlug(post))
  );

  return [...combinedPosts, ...shuffleArray(remainingPosts)].slice(0, limit);
}

const { headings, currentPost } = Astro.props;
const tableOfContents = buildToc(headings);

// Get related posts for desktop sidebar
let relatedPosts: CollectionEntry<'posts'>[] = [];
if (currentPost) {
  const allPosts = await getCollection('posts');
  const currentSlug = getEntrySlug(currentPost);
  const otherPosts = allPosts.filter(post => getEntrySlug(post) !== currentSlug);
  relatedPosts = getRelatedPosts(currentPost, otherPosts, 3);
}
---

<!-- Desktop Sticky Sidebar TOC -->
<aside id="desktop-toc" class="hidden lg:block fixed top-24 z-40 opacity-0 pointer-events-none transition-all duration-300" style="left: max(1rem, calc(50vw - 32rem - 21rem));" aria-label="Table of contents">
  <!-- Collapsed state - just a button -->
  <button
    id="desktop-toc-expand"
    class="hidden w-10 h-10 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
    aria-label="Expand table of contents"
    title="Show Table of Contents"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z" clip-rule="evenodd" />
    </svg>
  </button>

  <!-- Expanded state - full TOC panel -->
  <div id="desktop-toc-panel" class="w-60 xl:w-64 max-h-[calc(100vh-8rem)] bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col">
    <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
      <h2 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z" clip-rule="evenodd" />
        </svg>
        On This Page
      </h2>
      <button
        id="desktop-toc-collapse"
        class="p-1 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
        aria-label="Collapse table of contents"
        title="Hide Table of Contents"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
    <nav class="toc-nav overflow-y-auto flex-shrink min-h-0 p-3">
      <ul class="space-y-0.5">
        {tableOfContents.map((heading) => (
          <li>
            <a
              href={`#${heading.slug}`}
              data-toc-link
              data-slug={heading.slug}
              class="toc-link block py-1.5 px-3 text-sm text-gray-600 dark:text-gray-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-200 truncate"
              title={heading.text}
            >
              {heading.text}
            </a>
            {heading.subheadings.length > 0 && (
              <ul class="ml-3 mt-0.5 space-y-0.5 border-l-2 border-gray-100 dark:border-gray-700">
                {heading.subheadings.map((subheading) => (
                  <li>
                    <a
                      href={`#${subheading.slug}`}
                      data-toc-link
                      data-slug={subheading.slug}
                      class="toc-link block py-1 px-3 text-xs text-gray-500 dark:text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-200 truncate"
                      title={subheading.text}
                    >
                      {subheading.text}
                    </a>
                    {subheading.subheadings && subheading.subheadings.length > 0 && (
                      <ul class="ml-3 mt-0.5 space-y-0.5">
                        {subheading.subheadings.map((h3) => (
                          <li>
                            <a
                              href={`#${h3.slug}`}
                              data-toc-link
                              data-slug={h3.slug}
                              class="toc-link block py-1 px-2 text-xs text-gray-400 dark:text-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-200 truncate"
                              title={h3.text}
                            >
                              {h3.text}
                            </a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>
    </nav>

    <!-- Related Posts Section -->
    {relatedPosts.length > 0 && (
      <div class="border-t border-gray-100 dark:border-gray-700 overflow-y-auto flex-shrink-0">
        <div class="px-3 py-3">
          <h3 class="text-xs font-semibold text-gray-900 dark:text-white mb-3">Related Posts</h3>
          <div class="space-y-4">
            {relatedPosts.map((post) => {
              const href = getEntryHref(post);
              return (
                <a href={href} class="group block">
                  {post.data.image && (
                    <div class="aspect-video w-full rounded-lg overflow-hidden mb-2">
                      <Image
                        src={post.data.image}
                        alt={post.data.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200"
                        width={256}
                        height={144}
                        loading="lazy"
                      />
                    </div>
                  )}
                  <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 leading-snug line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                    {post.data.title}
                  </h4>
                </a>
              );
            })}
          </div>
        </div>
      </div>
    )}
  </div>
</aside>

<!-- Mobile Floating TOC Button & Panel -->
<div id="mobile-toc" class="lg:hidden fixed bottom-6 right-6 z-50">
  <!-- Toggle Button -->
  <button
    id="mobile-toc-toggle"
    aria-label="Toggle table of contents"
    aria-expanded="false"
    class="w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center"
  >
    <svg id="toc-icon-menu" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z" clip-rule="evenodd" />
    </svg>
    <svg id="toc-icon-close" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 hidden" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
    </svg>
  </button>

  <!-- Mobile TOC Panel -->
  <div
    id="mobile-toc-panel"
    class="absolute bottom-16 right-0 w-80 max-w-[calc(100vw-3rem)] max-h-[60vh] bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transform scale-95 opacity-0 pointer-events-none transition-all duration-300 origin-bottom-right"
  >
    <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
      <h2 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z" clip-rule="evenodd" />
        </svg>
        Table of Contents
      </h2>
    </div>
    <nav class="overflow-y-auto max-h-[calc(60vh-3rem)] p-3">
      <ul class="space-y-0.5">
        {tableOfContents.map((heading) => (
          <li>
            <a
              href={`#${heading.slug}`}
              data-mobile-toc-link
              class="block py-1.5 px-3 text-sm text-gray-600 dark:text-gray-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-200"
            >
              {heading.text}
            </a>
            {heading.subheadings.length > 0 && (
              <ul class="ml-3 mt-0.5 space-y-0.5 border-l-2 border-gray-100 dark:border-gray-700">
                {heading.subheadings.map((subheading) => (
                  <li>
                    <a
                      href={`#${subheading.slug}`}
                      data-mobile-toc-link
                      class="block py-1 px-3 text-xs text-gray-500 dark:text-gray-500 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-200"
                    >
                      {subheading.text}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>
    </nav>
  </div>
</div>

<!-- Inline TOC removed - using mobile floating popup TOC instead to reduce DOM size -->

<script>
  function initTOC() {
    // Desktop TOC - Show when scrolling past hero section
    const desktopToc = document.getElementById('desktop-toc');
    const desktopTocPanel = document.getElementById('desktop-toc-panel');
    const desktopTocExpand = document.getElementById('desktop-toc-expand');
    const desktopTocCollapse = document.getElementById('desktop-toc-collapse');
    const article = document.querySelector('article');

    // Track collapsed state (default: expanded)
    let isDesktopTocCollapsed = localStorage.getItem('desktop-toc-collapsed') === 'true';

    // Apply initial collapsed state
    const applyDesktopTocState = () => {
      if (isDesktopTocCollapsed) {
        desktopTocPanel?.classList.add('hidden');
        desktopTocExpand?.classList.remove('hidden');
        desktopTocExpand?.classList.add('flex');
      } else {
        desktopTocPanel?.classList.remove('hidden');
        desktopTocExpand?.classList.add('hidden');
        desktopTocExpand?.classList.remove('flex');
      }
    };

    if (desktopToc && article) {
      applyDesktopTocState();

      const showTocOnScroll = () => {
        const articleTop = article.getBoundingClientRect().top;
        const shouldShow = articleTop < 100;

        if (shouldShow) {
          desktopToc.classList.remove('opacity-0', 'pointer-events-none');
          desktopToc.classList.add('opacity-100', 'pointer-events-auto');
        } else {
          desktopToc.classList.add('opacity-0', 'pointer-events-none');
          desktopToc.classList.remove('opacity-100', 'pointer-events-auto');
        }
      };

      window.addEventListener('scroll', showTocOnScroll, { passive: true });
      showTocOnScroll();

      // Collapse button handler
      desktopTocCollapse?.addEventListener('click', () => {
        isDesktopTocCollapsed = true;
        localStorage.setItem('desktop-toc-collapsed', 'true');
        applyDesktopTocState();
      });

      // Expand button handler
      desktopTocExpand?.addEventListener('click', () => {
        isDesktopTocCollapsed = false;
        localStorage.setItem('desktop-toc-collapsed', 'false');
        applyDesktopTocState();
      });
    }

    // Active heading highlighting
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    const headings = document.querySelectorAll('h2[id], h3[id], h4[id]');
    const tocNav = document.querySelector('.toc-nav');

    if (tocLinks.length > 0 && headings.length > 0) {
      let lastActiveSlug = '';

      const highlightActiveHeading = () => {
        let activeSlug = '';

        headings.forEach((heading) => {
          const rect = heading.getBoundingClientRect();
          if (rect.top <= 120) {
            activeSlug = heading.id;
          }
        });

        tocLinks.forEach((link) => {
          const linkSlug = link.getAttribute('data-slug');
          if (linkSlug === activeSlug) {
            link.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-medium');
            link.classList.remove('text-gray-600', 'dark:text-gray-400', 'text-gray-500', 'dark:text-gray-500');

            // Auto-scroll TOC to show active link
            if (tocNav && activeSlug !== lastActiveSlug) {
              const linkRect = link.getBoundingClientRect();
              const navRect = tocNav.getBoundingClientRect();
              
              if (linkRect.top < navRect.top || linkRect.bottom > navRect.bottom) {
                link.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            }
          } else {
            link.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-medium');
            if (link.classList.contains('text-xs')) {
              link.classList.add('text-gray-500', 'dark:text-gray-500');
            } else {
              link.classList.add('text-gray-600', 'dark:text-gray-400');
            }
          }
        });

        lastActiveSlug = activeSlug;
      };

      window.addEventListener('scroll', highlightActiveHeading, { passive: true });
      highlightActiveHeading();
    }

    // Mobile TOC toggle
    const mobileToggle = document.getElementById('mobile-toc-toggle');
    const mobilePanel = document.getElementById('mobile-toc-panel');
    const menuIcon = document.getElementById('toc-icon-menu');
    const closeIcon = document.getElementById('toc-icon-close');
    const mobileLinks = document.querySelectorAll('[data-mobile-toc-link]');

    if (mobileToggle && mobilePanel) {
      const toggleMobileToc = () => {
        const isOpen = mobilePanel.classList.contains('opacity-100');

        if (isOpen) {
          mobilePanel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
          mobilePanel.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
          menuIcon?.classList.remove('hidden');
          closeIcon?.classList.add('hidden');
          mobileToggle.setAttribute('aria-expanded', 'false');
        } else {
          mobilePanel.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
          mobilePanel.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
          menuIcon?.classList.add('hidden');
          closeIcon?.classList.remove('hidden');
          mobileToggle.setAttribute('aria-expanded', 'true');
        }
      };

      mobileToggle.addEventListener('click', toggleMobileToc);

      // Close panel when clicking a link
      mobileLinks.forEach((link) => {
        link.addEventListener('click', () => {
          mobilePanel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
          mobilePanel.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
          menuIcon?.classList.remove('hidden');
          closeIcon?.classList.add('hidden');
          mobileToggle.setAttribute('aria-expanded', 'false');
        });
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        const mobileToc = document.getElementById('mobile-toc');
        if (mobileToc && !mobileToc.contains(e.target as Node)) {
          mobilePanel.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
          mobilePanel.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
          menuIcon?.classList.remove('hidden');
          closeIcon?.classList.add('hidden');
          mobileToggle.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Inline TOC removed - using mobile floating popup TOC instead
  }

  // Initialize on page load and after view transitions
  document.addEventListener('astro:page-load', initTOC);
</script>

<style>
  /* Scrollbar styling for TOC nav */
  .toc-nav {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.3) transparent;
  }

  .toc-nav::-webkit-scrollbar {
    width: 4px;
  }

  .toc-nav::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-nav::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.3);
    border-radius: 20px;
  }

  .toc-nav::-webkit-scrollbar-thumb:hover {
    background-color: rgba(156, 163, 175, 0.5);
  }

  .dark .toc-nav::-webkit-scrollbar-thumb {
    background-color: rgba(75, 85, 99, 0.5);
  }

  /* Mobile panel animation */
  #mobile-toc-panel {
    will-change: transform, opacity;
  }

  /* Prevent body scroll when mobile TOC is open */
  body.toc-open {
    overflow: hidden;
  }
</style>
