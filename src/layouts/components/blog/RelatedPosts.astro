---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import { formatDate } from '@utils/date';
import { getEntryHref, getEntrySlug } from '@utils/content';

interface Props {
  currentPost: any;
  limit?: number;
}

const { currentPost, limit = 3 } = Astro.props as { currentPost: CollectionEntry<'posts'>; limit?: number };
const allPosts = await getCollection('posts');
const currentSlug = getEntrySlug(currentPost);

// Filter out the current post
const otherPosts = allPosts.filter(post => getEntrySlug(post) !== currentSlug);

// Function to get related posts
function getRelatedPosts(currentPost: CollectionEntry<'posts'>, otherPosts: CollectionEntry<'posts'>[], limit: number): CollectionEntry<'posts'>[] {
  // Get posts with matching tags
  const postsByTags = otherPosts.filter(post => {
    const postTags = post.data.tags || [];
    const currentTags = currentPost.data.tags || [];
    return currentTags.some((tag: string) => postTags.includes(tag));
  });

  // If we have enough posts with matching tags, return them
  if (postsByTags.length >= limit) {
    return shuffleArray(postsByTags).slice(0, limit);
  }

  // If we don't have enough posts with matching tags, get posts with matching categories
  const postsByCategories = otherPosts.filter(post => {
    const postCategories = post.data.categories || [];
    const currentCategories = currentPost.data.categories || [];
    return currentCategories.some((category: string) => postCategories.includes(category));
  });

  // Combine unique posts from tags and categories
  const combinedPosts = [...postsByTags];

  postsByCategories.forEach(post => {
    if (!combinedPosts.some(p => getEntrySlug(p) === getEntrySlug(post))) {
      combinedPosts.push(post);
    }
  });

  if (combinedPosts.length >= limit) {
    return shuffleArray(combinedPosts).slice(0, limit);
  }

  // Add random posts if needed
  const remainingPosts = otherPosts.filter(post =>
    !combinedPosts.some((p) => getEntrySlug(p) === getEntrySlug(post))
  );

  return [...combinedPosts, ...shuffleArray(remainingPosts)].slice(0, limit);
}

function shuffleArray<T>(array: T[]): T[] {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
}

const relatedPosts = getRelatedPosts(currentPost, otherPosts, limit);
---

<section class="related-posts mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
  <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Related Posts</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    {relatedPosts.map((post) => {
      const href = getEntryHref(post);
      const category = post.data.categories?.[0];

      return (
        <article class="related-post-card group">
          <a href={href} class="block">
            {/* Image */}
            {post.data.image && (
              <div class="aspect-video overflow-hidden rounded-lg mb-3">
                <Image
                  src={post.data.image}
                  alt={post.data.title}
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  width={400}
                  height={225}
                  loading="lazy"
                />
              </div>
            )}

            {/* Category badge - only first one */}
            {category && (
              <span class="inline-block text-xs font-medium px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full mb-2">
                {category}
              </span>
            )}

            {/* Title */}
            <h3 class="text-lg font-bold text-gray-900 dark:text-white line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
              {post.data.title}
            </h3>

            {/* Date only - simplified */}
            {post.data.date && (
              <time
                datetime={post.data.date.toISOString()}
                class="text-sm text-gray-500 dark:text-gray-400 mt-2 block"
              >
                {formatDate(post.data.date)}
              </time>
            )}
          </a>
        </article>
      );
    })}
  </div>
</section>

<style>
  .related-post-card {
    background: transparent;
  }

  .related-post-card:hover h3 {
    color: rgb(37, 99, 235);
  }

  :global(.dark) .related-post-card:hover h3 {
    color: rgb(96, 165, 250);
  }
</style>
