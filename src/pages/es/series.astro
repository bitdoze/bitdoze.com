---
import { getCollection } from 'astro:content';
import Layout from '@layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
import { getEntryHref, getEntrySlug } from '@utils/content';
import { siteConfig } from '@config/site';
import { isPostIdInLocale } from '@utils/i18n';

const allPosts = await getCollection('posts', ({ id, data }) => !data.draft && isPostIdInLocale(id, 'es'));

const seriesMap = new Map();

allPosts.forEach((post) => {
  if (post.data.series && Array.isArray(post.data.series) && post.data.series.length === 2) {
    const [seriesName, seriesPosition] = post.data.series;

    if (!seriesMap.has(seriesName)) {
      seriesMap.set(seriesName, []);
    }

    seriesMap.get(seriesName).push({
      title: post.data.title,
      slug: getEntrySlug(post),
      href: getEntryHref(post),
      position: seriesPosition,
      description: post.data.description,
    });
  }
});

for (const posts of seriesMap.values()) {
  posts.sort((a: any, b: any) => {
    const posA = parseInt(a.position || '0', 10);
    const posB = parseInt(b.position || '0', 10);
    return posA - posB;
  });
}

const seriesList = Array.from(seriesMap.entries()).map(([name, posts]) => ({
  name,
  posts,
  count: posts.length,
}));
---

<Layout
  title={`Series en Espanol - ${siteConfig.name}`}
  description="Coleccion de series de articulos en espanol"
  lang="es"
  hreflangs={[
    { lang: 'en', href: `${Astro.site || siteConfig.url}/series/` },
    { lang: 'es', href: `${Astro.site || siteConfig.url}/es/series/` },
    { lang: 'x-default', href: `${Astro.site || siteConfig.url}/series/` },
  ]}
>
  <div class="max-w-5xl mx-auto px-4 sm:px-6 py-12">
    <header class="mb-12">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">Series de articulos</h1>
      <p class="text-lg text-gray-700 dark:text-gray-300">Guias por partes para aprender de forma progresiva.</p>
    </header>

    {seriesList.length === 0 ? (
      <div class="text-center py-12">
        <p class="text-gray-600 dark:text-gray-400">Aun no hay series en espanol.</p>
      </div>
    ) : (
      <div class="space-y-10">
        {seriesList.map((series) => (
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
              <Icon name="mdi:book-open-variant" class="w-6 h-6 mr-2 text-blue-600 dark:text-blue-400" />
              {series.name}
            </h2>

            <ol class="space-y-3">
              {series.posts.map((post: any) => (
                <li>
                  <a href={post.href} class="text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400">
                    <span class="font-semibold mr-2">{post.position}.</span>
                    {post.title}
                  </a>
                </li>
              ))}
            </ol>
          </div>
        ))}
      </div>
    )}
  </div>
</Layout>
